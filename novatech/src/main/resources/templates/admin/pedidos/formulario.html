<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido - NovaTech Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>

<body>
    <nav th:replace="~{admin/fragments/topbar :: topbar}"></nav>

    <div class="container-fluid">
        <div class="row">
            <nav th:replace="~{admin/fragments/sidebar :: sidebar('pedidos')}"></nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" th:text="${pedidoForm.id == null ? 'Nuevo Pedido' : 'Editar Pedido'}">Pedido</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a th:href="@{/admin/pedidos}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Volver
                        </a>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-10 mx-auto">
                        <div class="card mb-4">
                            <div class="card-body">
                                <form th:action="@{/admin/pedidos/guardar}" th:object="${pedidoForm}" method="post" id="pedidoForm">
                                    <input type="hidden" th:field="*{id}" />
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="usuarioId" class="form-label">Cliente *</label>
                                            <select class="form-select" id="usuarioId" th:field="*{usuarioId}" required>
                                                <option value="">Seleccione un cliente</option>
                                                <option th:each="user : ${usuarios}" th:value="${user.id}" th:text="${user.nombre + ' ' + user.apellido + ' (' + user.email + ')'}"></option>
                                            </select>
                                            <div class="text-danger" th:if="${#fields.hasErrors('usuarioId')}" th:errors="*{usuarioId}"></div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="estado" class="form-label">Estado *</label>
                                            <select class="form-select" id="estado" th:field="*{estado}" required>
                                                <option th:each="estadoOpt : ${estados}" th:value="${estadoOpt}" th:text="${estadoOpt}"></option>
                                            </select>
                                            <div class="text-danger" th:if="${#fields.hasErrors('estado')}" th:errors="*{estado}"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fecha" class="form-label">Fecha *</label>
                                            <input type="datetime-local" class="form-control" id="fecha" th:field="*{fecha}" required>
                                            <div class="text-danger" th:if="${#fields.hasErrors('fecha')}" th:errors="*{fecha}"></div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="total" class="form-label">Total *</label>
                                            <div class="input-group">
                                                <span class="input-group-text">S/.</span>
                                                <input type="number" class="form-control" id="total" th:field="*{total}" step="0.01" min="0" required readonly>
                                            </div>
                                            <div class="text-danger" th:if="${#fields.hasErrors('total')}" th:errors="*{total}"></div>
                                            <small class="form-text text-muted">El total se calcula automáticamente según los productos agregados</small>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4 mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Agregar Producto</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="productoSelect" class="form-label">Producto</label>
                                                    <select class="form-select" id="productoSelect">
                                                        <option value="">Seleccione un producto</option>
                                                        <option th:each="producto : ${productos}" th:value="${producto.id}" 
                                                                th:text="${producto.nombre + ' - S/. ' + #numbers.formatDecimal(producto.precio, 1, 2)}"
                                                                th:data-precio="${producto.precio}">
                                                        </option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-3 mb-3">
                                                    <label for="cantidadInput" class="form-label">Cantidad</label>
                                                    <input type="number" class="form-control" id="cantidadInput" value="1" min="1">
                                                </div>
                                                
                                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                                    <button type="button" class="btn btn-primary w-100" id="agregarProductoBtn">
                                                        <i class="fas fa-plus me-1"></i> Agregar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive mb-4">
                                        <table class="table table-striped table-hover" id="tablaProductos">
                                            <thead>
                                                <tr>
                                                    <th>Producto</th>
                                                    <th>Precio</th>
                                                    <th>Cantidad</th>
                                                    <th>Subtotal</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productosTableBody">
                                                <tr th:if="${pedidoForm.detalles == null || pedidoForm.detalles.empty}" id="emptyRow">
                                                    <td colspan="5" class="text-center">No hay productos en este pedido</td>
                                                </tr>
                                                <tr th:each="detalle, stat : ${pedidoForm.detalles}" th:id="${'producto-row-' + stat.index}">
                                                    <td>
                                                        <input type="hidden" th:field="*{detalles[__${stat.index}__].id}" />
                                                        <input type="hidden" th:field="*{detalles[__${stat.index}__].productoId}" class="producto-id" />
                                                        <span th:text="${productos.stream().filter(p -> p.id == detalle.productoId).findFirst().orElse(null)?.nombre}">Producto</span>
                                                    </td>
                                                    <td>
                                                        <input type="hidden" th:field="*{detalles[__${stat.index}__].precioUnitario}" class="precio-unitario" />
                                                        <span th:text="${'S/. ' + #numbers.formatDecimal(detalle.precioUnitario, 1, 2)}">S/. 0.00</span>
                                                    </td>
                                                    <td>
                                                        <input type="number" th:field="*{detalles[__${stat.index}__].cantidad}" class="form-control form-control-sm cantidad-input" min="1" style="width: 80px;" />
                                                    </td>
                                                    <td>
                                                        <input type="hidden" th:field="*{detalles[__${stat.index}__].subtotal}" class="subtotal" />
                                                        <span th:text="${'S/. ' + #numbers.formatDecimal(detalle.subtotal, 1, 2)}" class="subtotal-text">S/. 0.00</span>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm eliminar-producto">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <a th:href="@{/admin/pedidos}" class="btn btn-secondary me-md-2">Cancelar</a>
                                        <button type="submit" class="btn btn-primary">Guardar Pedido</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin.js}"></script>
    
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const productoSelect = document.getElementById('productoSelect');
            const cantidadInput = document.getElementById('cantidadInput');
            const agregarProductoBtn = document.getElementById('agregarProductoBtn');
            const productosTableBody = document.getElementById('productosTableBody');
            const emptyRow = document.getElementById('emptyRow');
            const totalInput = document.getElementById('total');
            
            const productos = /*[[${productos}]]*/ [];
            
            let productoCounter = /*[[${pedidoForm.detalles != null ? pedidoForm.detalles.size() : 0}]]*/ 0;
            
            calcularTotal();
            
            agregarProductoBtn.addEventListener('click', function() {
                const productoId = productoSelect.value;
                const cantidad = parseInt(cantidadInput.value);
                
                if (!productoId || isNaN(cantidad) || cantidad <= 0) {
                    alert('Por favor, seleccione un producto y una cantidad válida');
                    return;
                }
                
                const productoSeleccionado = productos.find(p => p.id == productoId);
                if (!productoSeleccionado) return;
                
                const existingRow = document.querySelector(`input.producto-id[value="${productoId}"]`);
                if (existingRow) {
                    const row = existingRow.closest('tr');
                    const cantidadInput = row.querySelector('.cantidad-input');
                    cantidadInput.value = parseInt(cantidadInput.value) + cantidad;
                    actualizarSubtotal(row);
                    calcularTotal();
                    return;
                }
                
                if (emptyRow && emptyRow.parentNode) {
                    emptyRow.remove();
                }
                
                const precioUnitario = productoSeleccionado.precio;
                const subtotal = precioUnitario * cantidad;
                
                const newRow = document.createElement('tr');
                newRow.id = `producto-row-${productoCounter}`;
                
                newRow.innerHTML = `
                    <td>
                        <input type="hidden" name="detalles[${productoCounter}].id" value="" />
                        <input type="hidden" name="detalles[${productoCounter}].productoId" value="${productoId}" class="producto-id" />
                        ${productoSeleccionado.nombre}
                    </td>
                    <td>
                        <input type="hidden" name="detalles[${productoCounter}].precioUnitario" value="${precioUnitario}" class="precio-unitario" />
                        S/. ${precioUnitario.toFixed(2)}
                    </td>
                    <td>
                        <input type="number" name="detalles[${productoCounter}].cantidad" value="${cantidad}" class="form-control form-control-sm cantidad-input" min="1" style="width: 80px;" />
                    </td>
                    <td>
                        <input type="hidden" name="detalles[${productoCounter}].subtotal" value="${subtotal}" class="subtotal" />
                        <span class="subtotal-text">S/. ${subtotal.toFixed(2)}</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm eliminar-producto">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                productosTableBody.appendChild(newRow);
                
                const eliminarBtn = newRow.querySelector('.eliminar-producto');
                eliminarBtn.addEventListener('click', function() {
                    newRow.remove();
                    calcularTotal();
                    
                    if (productosTableBody.children.length === 0) {
                        const emptyRowHtml = `<tr id="emptyRow"><td colspan="5" class="text-center">No hay productos en este pedido</td></tr>`;
                        productosTableBody.innerHTML = emptyRowHtml;
                    }
                });
                
                const cantidadInputField = newRow.querySelector('.cantidad-input');
                cantidadInputField.addEventListener('change', function() {
                    actualizarSubtotal(newRow);
                    calcularTotal();
                });
                
                productoCounter++;
                
                productoSelect.value = '';
                cantidadInput.value = 1;
                
                calcularTotal();
            });
            
            function actualizarSubtotal(row) {
                const precioUnitario = parseFloat(row.querySelector('.precio-unitario').value);
                const cantidad = parseInt(row.querySelector('.cantidad-input').value);
                const subtotal = precioUnitario * cantidad;
                
                row.querySelector('.subtotal').value = subtotal;
                row.querySelector('.subtotal-text').textContent = `S/. ${subtotal.toFixed(2)}`;
            }
            
            function calcularTotal() {
                const subtotales = document.querySelectorAll('.subtotal');
                let total = 0;
                
                subtotales.forEach(function(subtotalInput) {
                    total += parseFloat(subtotalInput.value || 0);
                });
                
                totalInput.value = total.toFixed(2);
            }
            
            document.querySelectorAll('.cantidad-input').forEach(function(input) {
                input.addEventListener('change', function() {
                    actualizarSubtotal(input.closest('tr'));
                    calcularTotal();
                });
            });
            
            document.querySelectorAll('.eliminar-producto').forEach(function(button) {
                button.addEventListener('click', function() {
                    const row = button.closest('tr');
                    row.remove();
                    calcularTotal();
                    
                    if (productosTableBody.children.length === 0) {
                        const emptyRowHtml = `<tr id="emptyRow"><td colspan="5" class="text-center">No hay productos en este pedido</td></tr>`;
                        productosTableBody.innerHTML = emptyRowHtml;
                    }
                });
            });
        });
    </script>
</body>

</html>